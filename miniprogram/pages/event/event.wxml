<view class="container">
  <canvas type="2d" id="shareCanvas" style="width:1px;height:1px;opacity:0;position:fixed;left:0;top:0;"></canvas>
  <block wx:if="{{!dataLoaded}}">
    <view class="card loading-card">
      <view class="loading-text">{{i18n.common_loading}}</view>
    </view>
  </block>
  <block wx:else>
    <view class="card">
      <view class="event-header">
        <view class="title">{{event.title}}</view>
        <view class="status-badge {{event.status}}">{{event.status}}</view>
      </view>
      <view class="label">{{event.date}} - {{event.location}}</view>
      <view class="label" wx:if="{{event.startTime}}">{{event.startTime}} - {{event.endTime}}</view>
    </view>

    <block wx:if="{{isAdmin}}">
      <view class="card">
        <view class="title">{{i18n.nav_admin}}</view>
        <view class="button {{signedUpPlayers.length < minPlayersForMatchups ? 'disabled' : ''}}" bindtap="{{signedUpPlayers.length < minPlayersForMatchups ? '' : 'generateMatchups'}}" wx:if="{{event.status === 'open'}}">{{i18n.admin_generate_matchups || 'Generate Matchups'}}</view>
        <view class="button secondary {{signedUpPlayers.length < minPlayersForMatchups ? 'disabled' : ''}}" bindtap="{{signedUpPlayers.length < minPlayersForMatchups ? '' : 'confirmRegenerateMatchups'}}" wx:if="{{event.status === 'in_progress'}}">{{i18n.admin_regenerate_matchups || 'Regenerate Matchups'}}</view>
        <view class="hint" wx:if="{{event.status === 'open' && signedUpPlayers.length < minPlayersForMatchups}}">{{event.eventType === 'singles' ? i18n.admin_min_players_hint_singles : i18n.admin_min_players_hint || 'Minimum 4 players required'}}</view>
        <view class="hint" wx:if="{{event.status === 'match_started'}}">{{i18n.admin_match_started_hint || 'Matches have started - cannot regenerate'}}</view>
        <view class="button" bindtap="completeEvent" wx:if="{{event.status !== 'completed' && matches.length > 0}}">{{i18n.admin_complete_event || 'Complete Event'}}</view>

        <block wx:if="{{!event.leaderboard || !event.leaderboard.computed}}">
          <view class="button {{!hasCompletedMatches || event.status !== 'completed' ? 'disabled' : ''}}" bindtap="{{hasCompletedMatches && event.status === 'completed' ? 'computeScore' : ''}}">{{i18n.admin_compute_score || 'Compute Score'}}</view>
        </block>

        <view class="button secondary" bindtap="reopenEvent" wx:if="{{event.status === 'completed'}}">{{i18n.admin_reopen_event || 'Reopen Event'}}</view>

        <block wx:if="{{event.leaderboard && event.leaderboard.computed}}">
          <view class="locked-notice">
            <text class="lock-icon">üîí</text>
            <text>{{i18n.event_score_locked || 'Score finalized'}}</text>
          </view>
        </block>

        <view class="button danger" bindtap="deleteEvent" wx:if="{{!event.leaderboard || !event.leaderboard.computed}}">{{i18n.admin_delete_event || 'Delete Event'}}</view>

        <block wx:if="{{event.status !== 'completed'}}">
          <view class="divider"></view>

          <view class="button secondary" bindtap="toggleAddMatchup" wx:if="{{!showAddMatchup}}">{{i18n.admin_add_matchup || '+ Add Matchup'}}</view>
          <block wx:if="{{showAddMatchup}}">
            <view class="add-matchup-form">
              <view class="label">{{i18n.admin_match_type}}</view>
              <picker mode="selector" range="{{matchTypes}}" range-key="label" bindchange="onAddMatchupTypePicker">
                <view class="picker-value">{{newMatchup.matchTypeLabel || i18n.common_select}}</view>
              </picker>

              <view class="label">{{i18n.admin_team_a}}</view>
              <searchable-picker
                items="{{filteredPlayersForMatchup}}"
                selectedIds="{{newMatchup.teamA}}"
                excludeIds="{{newMatchup.teamB}}"
                placeholder="{{i18n.common_search}}"
                maxSelect="{{newMatchup.maxPlayers}}"
                bind:change="onAddMatchupTeamAChange"
              />

              <view class="team-b-section">
                <view class="label">{{i18n.admin_team_b}}</view>
                <searchable-picker
                  items="{{filteredPlayersForMatchup}}"
                  selectedIds="{{newMatchup.teamB}}"
                  excludeIds="{{newMatchup.teamA}}"
                  placeholder="{{i18n.common_search}}"
                  maxSelect="{{newMatchup.maxPlayers}}"
                  bind:change="onAddMatchupTeamBChange"
                />
              </view>

              <view class="button-row">
                <view class="button" bindtap="addMatchup">{{i18n.common_save}}</view>
                <view class="button secondary" bindtap="toggleAddMatchup">{{i18n.common_cancel}}</view>
              </view>
            </view>
          </block>
        </block>
      </view>
    </block>

    <!-- Leaderboard display for completed events with computed scores -->
    <block wx:if="{{event.status === 'completed' && event.leaderboard && event.leaderboard.rankings}}">
      <view class="card">
        <view class="title">{{i18n.event_leaderboard || 'Leaderboard'}}</view>

        <view class="leaderboard-table">
          <view class="leaderboard-header">
            <text class="col-player">{{i18n.players_title || 'Player'}}</text>
            <text class="col-wins">{{i18n.stats_wins || 'Wins'}}</text>
            <text class="col-points">{{i18n.stats_points || 'Points'}}</text>
            <text class="col-remarks">{{i18n.common_remarks || 'Remarks'}}</text>
          </view>

          <view
            wx:for="{{event.leaderboard.rankings}}"
            wx:key="playerId"
            class="leaderboard-row {{item.rank <= 2 ? 'top-' + item.rank : ''}}"
          >
            <text class="col-player">{{item.playerName}}</text>
            <text class="col-wins">
              {{item.wins}}<text wx:if="{{showGameDiff}}" class="game-diff"> ({{item.gameDifference >= 0 ? '+' : ''}}{{item.gameDifference}})</text>
            </text>
            <text class="col-points">{{item.totalPoints}}</text>
            <view class="col-remarks">
              <text wx:if="{{item.rank === 1}}" class="trophy">üèÜ</text>
              <text wx:if="{{item.rank === 2}}" class="trophy">ü•à</text>
              <text wx:if="{{item.bonus > 0}}" class="bonus">+{{item.bonus}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>

    <!-- Tie-breaker modal -->
    <block wx:if="{{showTieBreaker}}">
      <view class="modal-overlay" bindtap="closeTieBreaker">
        <view class="modal-content" catchtap="">
          <view class="modal-title">{{i18n.admin_tie_breaker_title || 'Tie Detected'}}</view>
          <view class="modal-body">
            <text class="modal-desc">{{i18n.admin_tie_breaker_desc || 'These players are tied on wins and game difference. Select the champion:'}}</text>
            <view class="tie-player-list">
              <view
                wx:for="{{tiedPlayers}}"
                wx:key="playerId"
                class="tie-player-option {{selectedChampion === item.playerId ? 'selected' : ''}}"
                data-player-id="{{item.playerId}}"
                bindtap="selectChampion"
              >
                <text class="tie-player-name">{{item.playerName}}</text>
                <text class="tie-player-stats">{{item.wins}} {{i18n.stats_wins}} ({{item.gameDifference >= 0 ? '+' : ''}}{{item.gameDifference}})</text>
              </view>
            </view>
          </view>
          <view class="modal-actions">
            <view class="button secondary" bindtap="closeTieBreaker">{{i18n.common_cancel}}</view>
            <view class="button {{!selectedChampion ? 'disabled' : ''}}" bindtap="confirmChampion">{{i18n.common_confirm || 'Confirm'}}</view>
          </view>
        </view>
      </view>
    </block>

    <view class="card">
      <view class="title">{{i18n.event_signed_players}} ({{signedUpPlayers.length}})</view>
      <block wx:if="{{signedUpPlayers.length === 0}}">
        <view class="label">{{i18n.event_no_players}}</view>
      </block>
      <block wx:else>
        <view class="player-list">
          <view wx:for="{{signedUpPlayers}}" wx:key="playerId" class="player-item">
            <view class="player-info">
              <view class="player-name-row">
                <text class="player-name">{{item.name}}</text>
                <text class="player-signup-time" wx:if="{{item.signedUpAt}}">{{item.signedUpAt}}</text>
              </view>
              <view class="player-badges">
                <text class="player-badge ntrp">NTRP {{item.ntrp || 'N/A'}}</text>
                <text class="player-badge gender {{item.gender === 'F' ? 'female' : 'male'}}">{{item.gender === 'F' ? i18n.gender_female : i18n.gender_male}}</text>
                <text class="player-badge test" wx:if="{{item.isTestPlayer}}">{{i18n.players_test_player}}</text>
              </view>
            </view>
            <view class="player-remove" wx:if="{{isAdmin && event.status !== 'completed'}}" data-player-id="{{item.playerId}}" catchtap="removePlayer">√ó</view>
          </view>
        </view>
      </block>

      <block wx:if="{{isAdmin && event.status !== 'completed'}}">
        <view class="divider"></view>
        <view class="button secondary" bindtap="toggleAddPlayer" wx:if="{{!showAddPlayer}}">{{i18n.admin_add_player || '+ Add Player'}}</view>
        <block wx:if="{{showAddPlayer}}">
          <view class="add-player-form">
            <view class="label">{{i18n.admin_select_player}}</view>
            <searchable-picker
              items="{{availablePlayersForSignup}}"
              selectedIds="{{selectedPlayerToAdd}}"
              placeholder="{{i18n.common_search}}"
              maxSelect="{{1}}"
              bind:change="onAddPlayerChange"
            />
            <view class="button-row">
              <view class="button" bindtap="addPlayerToEvent">{{i18n.admin_signup_player || 'Sign Up Player'}}</view>
              <view class="button secondary" bindtap="toggleAddPlayer">{{i18n.common_cancel}}</view>
            </view>
          </view>
        </block>
      </block>
    </view>

    <block wx:if="{{matches.length > 0}}">
      <view class="card">
        <view class="title">{{i18n.event_matches || 'Matches'}}</view>
        <view wx:for="{{matches}}" wx:key="_id" class="matchup-item {{item.status === 'completed' ? 'completed' : ''}}">
          <view class="matchup-row">
            <view class="matchup-content">
              <view class="matchup-header">
                <view class="matchup-type"><text class="matchup-number">#{{item.matchNumber || index + 1}}</text> {{item.matchTypeLabel}}</view>
                <view class="matchup-delete" data-id="{{item._id}}" catchtap="deleteMatchup" wx:if="{{isAdmin && event.status !== 'completed' && item.status !== 'completed'}}">√ó</view>
                <view class="matchup-delete" data-id="{{item._id}}" catchtap="clearResult" wx:if="{{isAdmin && item.status === 'completed' && (!event.leaderboard || !event.leaderboard.computed)}}">√ó</view>
              </view>
              <view class="matchup-versus">
                <view class="team-block team-a {{item.winner === 'A' ? 'winner' : ''}}">
                  <text class="team-name">{{item.teamANames}}</text>
                </view>
                <text class="vs-text">vs</text>
                <view class="team-block team-b {{item.winner === 'B' ? 'winner' : ''}}">
                  <text class="team-name">{{item.teamBNames}}</text>
                </view>
              </view>
              <view class="matchup-score" wx:if="{{item.score}}">{{item.score}}</view>
              <view class="matchup-pending" wx:if="{{!item.score && item.status !== 'completed'}}">{{i18n.event_pending || 'Pending'}}</view>
            </view>
          </view>
        </view>
      </view>
    </block>

    <block wx:if="{{isAdmin && pendingMatches.length > 0 && event.status !== 'completed'}}">
      <view class="card">
        <view class="title">{{i18n.admin_enter_result}}</view>

        <view class="label">{{i18n.admin_select_match}}</view>
        <view class="match-list">
          <view
            wx:for="{{pendingMatches}}"
            wx:key="_id"
            class="match-option {{resultEntry.selectedMatchId === item._id ? 'selected' : ''}}"
            data-id="{{item._id}}"
            bindtap="onResultMatchSelect"
          >
            <view class="match-teams">{{item.teamANames}} vs {{item.teamBNames}}</view>
            <view class="match-type">{{item.matchTypeLabel}}</view>
          </view>
        </view>

        <block wx:if="{{resultEntry.selectedMatchId}}">
          <view class="label">{{i18n.admin_set_scores}}</view>
          <view class="sets-container">
            <view wx:for="{{resultEntry.sets}}" wx:key="index" class="set-row-container">
              <view class="set-row">
                <text class="set-label">{{i18n.admin_set_label}}:</text>
                <picker
                  class="set-picker"
                  mode="selector"
                  range="{{scoreOptions}}"
                  value="{{item.teamAGamesIndex}}"
                  data-index="{{index}}"
                  data-team="teamAGames"
                  bindchange="onSetScorePick"
                >
                  <view class="set-input">{{item.teamAGames !== '' ? item.teamAGames : 'A'}}</view>
                </picker>
                <text class="set-separator">-</text>
                <picker
                  class="set-picker"
                  mode="selector"
                  range="{{scoreOptions}}"
                  value="{{item.teamBGamesIndex}}"
                  data-index="{{index}}"
                  data-team="teamBGames"
                  bindchange="onSetScorePick"
                >
                  <view class="set-input">{{item.teamBGames !== '' ? item.teamBGames : 'B'}}</view>
                </picker>
                <block wx:if="{{(item.teamAGames === '4' && item.teamBGames === '3') || (item.teamAGames === '3' && item.teamBGames === '4')}}">
                  <text class="tiebreak-label">{{i18n.admin_tiebreak || 'TB'}}:</text>
                  <input
                    class="tiebreak-input"
                    type="number"
                    data-index="{{index}}"
                    value="{{item.tiebreak}}"
                    bindinput="onTiebreakInput"
                    placeholder="{{item.teamAGames === '3' ? 'A' : 'B'}}"
                  />
                </block>
              </view>
            </view>
          </view>
          <view class="label">{{i18n.admin_winner}}</view>
          <view class="winner-buttons">
            <view
              class="winner-btn {{resultEntry.winner === 'A' ? 'selected' : ''}}"
              data-winner="A"
              bindtap="selectWinner"
            >
              <text class="winner-label">{{i18n.admin_team_a_wins || 'Team A Wins'}}</text>
              <text class="winner-names" wx:if="{{resultEntry.selectedMatch}}">{{resultEntry.selectedMatch.teamANames}}</text>
            </view>
            <view
              class="winner-btn {{resultEntry.winner === 'B' ? 'selected' : ''}}"
              data-winner="B"
              bindtap="selectWinner"
            >
              <text class="winner-label">{{i18n.admin_team_b_wins || 'Team B Wins'}}</text>
              <text class="winner-names" wx:if="{{resultEntry.selectedMatch}}">{{resultEntry.selectedMatch.teamBNames}}</text>
            </view>
          </view>

          <view class="button" bindtap="enterResult">{{i18n.admin_save_result || 'Save Result'}}</view>
        </block>
      </view>
    </block>

    <block wx:if="{{event.status !== 'completed'}}">
      <view class="card">
        <view class="title">{{i18n.event_signup_title}}</view>
        <view class="label">{{i18n.event_signup_status}}: {{signupStatus === 'signed' ? i18n.event_status_signed : i18n.event_not_signed}}</view>
        <block wx:if="{{signupStatus === 'signed'}}">
          <view class="button secondary" bindtap="withdraw" wx:if="{{event.status === 'open'}}">{{i18n.event_withdraw}}</view>
        </block>
        <block wx:else>
          <view class="button" bindtap="signup">{{i18n.event_submit_signup}}</view>
        </block>
      </view>
    </block>
    <block wx:else>
      <view class="card">
        <view class="label completed-notice">{{i18n.event_completed_notice || 'This event has been completed'}}</view>
      </view>
    </block>
  </block>
</view>
